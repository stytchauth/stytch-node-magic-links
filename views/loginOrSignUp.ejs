<!DOCTYPE html>
<html lang="en">
<head>
    <title>Hello Socks | Stytch example</title>
    <link rel="stylesheet" type="text/css" href="/css/styles.css">
    <script src="https://cdn.ethers.io/lib/ethers-5.0.umd.min.js" type="text/javascript" ></script>
</head>
<body>
<div class="app">
    <div class="nav">
        <h2>Hello Socks</h2>
        <div>
            <span class="navItem">Women</span>
            <span class="navItem">Men</span>
            <span class="navItem">Kids</span>
            <span class="navItem">Sale</span>
            <span class="navItem">Community</span>
        </div>
        <div>
            <img class="icon" src="/images/shopping-bag.png">
            <img class="icon" src="/images/person.png">
        </div>
    </div>
    <div class="content">
        <div class="card">
            <div class="cardContent">
                <h1>Almost there...</h1>
                <p>Sign up or log in to place your order. <br/>No password required!</p>
                <form action="/login_or_create_user" method="POST">
                    <div class="actions">
                        <input type="text" name="email" placeholder="example@email.com" />
                        <input class="arrow" type="image" src="/images/arrow.png">
                    </div>
                </form>
                <script>
                  async function login() {
                    await window.ethereum.request({
                      method: 'eth_requestAccounts',
                    });
                    let provider = new ethers.providers.Web3Provider(window.ethereum)
                    let [address] = await provider.listAccounts()

                    await fetch("http://localhost:3000/crypto_wallets/authenticate/start", {
                      method: "POST",
                      mode: 'cors',
                      body: new URLSearchParams({
                        'address': address,
                      }),
                      headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                      },
                    }).then((response) => {
                      if (response.ok) {
                        return response.json();
                      } else {
                        return Promise.reject(response);
                      }
                    }).then((data) => {
                      return data.challenge;
                    }).then((challenge) => {
                      return provider.getSigner().signMessage(challenge)
                    }).then((signature) => {
                      fetch("http://localhost:3000/crypto_wallets/authenticate", {
                        method: "POST",
                        mode: 'cors',
                        body: new URLSearchParams({
                          'address': address,
                          'signature': signature,
                        }),
                        headers: {
                          'Content-Type': 'application/x-www-form-urlencoded'
                        },
                      }).then((response) => {
                        if (response.ok) {
                          return response.json();
                        } else {
                          return Promise.reject(response);
                        }
                      }).then(() => {
                        location.reload();
                      });
                    });
                  }
                </script>
                <button id="button" onClick="login()">Login with MetaMask</button>
            </div>
        </div>
    </div>
</div>
</body>
</html>
